import streamlit as st
import pandas as pd
from datetime import date

st.set_page_config(page_title="ì—¬í–‰ ì„¤ë¬¸ ë¯¸ë‹ˆ ì•±", page_icon="ğŸ§³", layout="centered")
st.title("ğŸ§³ ì—¬í–‰ ì„¤ë¬¸ ë¯¸ë‹ˆ ì•±")
st.caption("ê°„ë‹¨ ì„¤ë¬¸ì„ ì œì¶œí•˜ë©´ ê²°ê³¼ ìš”ì•½ê³¼ CSV ë‹¤ìš´ë¡œë“œë¥¼ ì œê³µí•©ë‹ˆë‹¤.")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Session State ì´ˆê¸°í™”: ì„¤ë¬¸ ì‘ë‹µ ëˆ„ì /ì´ˆê¸°í™”ìš©
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "responses" not in st.session_state:
    st.session_state.responses = []  # ê° ì‘ë‹µ: dictë¡œ ì €ì¥

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1) ì„¤ë¬¸ í¼
# - formì„ ì“°ë©´ ì…ë ¥ ë„ì¤‘ì—ëŠ” ì•±ì´ ì¬ì‹¤í–‰ë˜ì§€ ì•Šê³ , submit ì‹œì ì—ë§Œ ì œì¶œ/ê²€ì¦ë©ë‹ˆë‹¤.
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.form(key="travel_survey"):
    st.subheader("1. ê¸°ë³¸ ì •ë³´")
    name = st.text_input("ì´ë¦„ (ì„ íƒ)", placeholder="í™ê¸¸ë™")
    mbti = st.radio(
        "MBTI",
        ("ISTJ", "ENFP", "ì„ íƒì§€ ì—†ìŒ"),
        horizontal=True,
        index=2
    )

    st.divider()
    st.subheader("2. ì—¬í–‰ ì„ í˜¸")
    destination = st.text_input("ê°€ê³  ì‹¶ì€ ì—¬í–‰ì§€*", placeholder="ì˜ˆ: ì˜¤í‚¤ë‚˜ì™€ / íŒŒë¦¬ / ë¶€ì‚°")
    travel_dates = st.date_input("ì—¬í–‰ ë‚ ì§œ(ë‹¨ì¼ ë˜ëŠ” ë²”ìœ„)", value=[date.today()])
    companions = st.multiselect("í•¨ê»˜ ê°€ëŠ” ì‚¬ëŒ", ["í˜¼ì", "ê°€ì¡±", "ì¹œêµ¬", "ì—°ì¸", "ë™ë£Œ"])
    activities = st.multiselect(
        "ê´€ì‹¬ í™œë™",
        ["ë§›ì§‘íƒë°©", "ìì—°/íŠ¸ë ˆí‚¹", "í•´ë³€/íœ´ì–‘", "ë°•ë¬¼ê´€/ì „ì‹œ", "ì‡¼í•‘", "ì•¡í‹°ë¹„í‹°"]
    )

    st.divider()
    st.subheader("3. ê¸°íƒ€")
    budget = st.slider("1ì¸ ì˜ˆìƒ ì˜ˆì‚°(ë§Œì›)", min_value=10, max_value=500, value=80, step=10)
    fruits = st.multiselect(
        "ì¢‹ì•„í•˜ëŠ” ê³¼ì¼(ì„ íƒ)",
        ["ë§ê³ ", "ì˜¤ë Œì§€", "ì‚¬ê³¼", "ë°”ë‚˜ë‚˜"],
        default=["ë§ê³ ", "ì˜¤ë Œì§€"]
    )
    agree = st.checkbox("ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.*")

    submitted = st.form_submit_button("ì„¤ë¬¸ ì œì¶œ", use_container_width=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2) ê²€ì¦ & ì œì¶œ ì²˜ë¦¬
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def normalize_dates(value):
    """date_inputê°€ ë‹¨ì¼/ë²”ìœ„ ëª¨ë‘ ê°€ëŠ¥í•˜ë¯€ë¡œ ë¬¸ìì—´ë¡œ ì¼ê´€ë˜ê²Œ ì •ë¦¬"""
    if isinstance(value, list) and len(value) == 2:
        return f"{value[0]} ~ {value[1]}"
    elif isinstance(value, list) and len(value) == 1:
        return str(value[0])
    elif isinstance(value, date):
        return str(value)
    return ""

if submitted:
    errors = []
    if not destination.strip():
        errors.append("ì—¬í–‰ì§€ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.")
    if not agree:
        errors.append("ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš©ì— ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.")

    if errors:
        for e in errors:
            st.error(e)
    else:
        record = {
            "ì´ë¦„": name or "(ë¯¸ì…ë ¥)",
            "MBTI": mbti,
            "ì—¬í–‰ì§€": destination.strip(),
            "ì—¬í–‰ë‚ ì§œ": normalize_dates(travel_dates),
            "ë™í–‰": ", ".join(companions) if companions else "(ì—†ìŒ)",
            "í™œë™": ", ".join(activities) if activities else "(ë¯¸ì„ íƒ)",
            "ì˜ˆì‚°(ë§Œì›)": budget,
            "ì¢‹ì•„í•˜ëŠ” ê³¼ì¼": ", ".join(fruits) if fruits else "(ë¯¸ì„ íƒ)",
        }
        st.session_state.responses.append(record)
        st.success("ì„¤ë¬¸ì´ ì •ìƒì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤! ì•„ë˜ì—ì„œ ê²°ê³¼ ìš”ì•½ì„ í™•ì¸í•˜ì„¸ìš”.")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3) ê²°ê³¼ ìš”ì•½(ê°œë³„ ì œì¶œ + ëˆ„ì  í†µê³„) & CSV ë‹¤ìš´ë¡œë“œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if len(st.session_state.responses) == 0:
    st.info("ì•„ì§ ì œì¶œëœ ì„¤ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤. í¼ì„ ì‘ì„±í•˜ê³  **ì„¤ë¬¸ ì œì¶œ** ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.")
else:
    st.markdown("---")
    st.subheader("ğŸ§¾ ìµœì‹  ì œì¶œ ìš”ì•½")

    latest = st.session_state.responses[-1]
    col1, col2 = st.columns(2)
    with col1:
        st.metric("ì—¬í–‰ì§€", latest["ì—¬í–‰ì§€"])
        st.metric("MBTI", latest["MBTI"])
        st.metric("ì˜ˆì‚°(ë§Œì›)", latest["ì˜ˆì‚°(ë§Œì›)"])
    with col2:
        st.markdown(f"**ì—¬í–‰ ë‚ ì§œ**: `{latest['ì—¬í–‰ë‚ ì§œ']}`")
        st.markdown(f"**ë™í–‰**: `{latest['ë™í–‰']}`")
        st.markdown(f"**ê´€ì‹¬ í™œë™**: `{latest['í™œë™']}`")
        st.markdown(f"**ì¢‹ì•„í•˜ëŠ” ê³¼ì¼**: `{latest['ì¢‹ì•„í•˜ëŠ” ê³¼ì¼']}`")

    # ëˆ„ì  ì‘ë‹µ í…Œì´ë¸”
    st.markdown("### ğŸ“‹ ëˆ„ì  ì‘ë‹µ")
    df = pd.DataFrame(st.session_state.responses)
    st.dataframe(df, use_container_width=True)

    # ê°„ë‹¨ í†µê³„(Top ì—¬í–‰ì§€/í™œë™)
    st.markdown("### ğŸ“ˆ ê°„ë‹¨ í†µê³„")
    c1, c2 = st.columns(2)
    with c1:
        top_dest = (
            df["ì—¬í–‰ì§€"].value_counts()
            .rename_axis("ì—¬í–‰ì§€")
            .reset_index(name="ì‘ë‹µìˆ˜")
        )
        st.caption("Top ì—¬í–‰ì§€")
        st.table(top_dest.head(5))
    with c2:
        # í™œë™ì€ ì½¤ë§ˆ ë¬¸ìì—´ â†’ explode
        if df["í™œë™"].notna().any():
            acts = (
                df.assign(í™œë™=df["í™œë™"].str.split(", "))
                  .explode("í™œë™")
            )
            acts = acts[acts["í™œë™"].notna() & (acts["í™œë™"] != "(ë¯¸ì„ íƒ)")]
            if not acts.empty:
                top_act = acts["í™œë™"].value_counts().rename_axis("í™œë™").reset_index(name="ì‘ë‹µìˆ˜")
                st.caption("Top í™œë™")
                st.table(top_act.head(5))
            else:
                st.info("í™œë™ í†µê³„ë¥¼ ê³„ì‚°í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        else:
            st.info("í™œë™ í†µê³„ë¥¼ ê³„ì‚°í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")

    # CSV ë‹¤ìš´ë¡œë“œ
    csv = df.to_csv(index=False).encode("utf-8")
    st.download_button(
        label="ğŸ“¥ ëˆ„ì  ì‘ë‹µ CSV ë‹¤ìš´ë¡œë“œ",
        data=csv,
        file_name="travel_survey_responses.csv",
        mime="text/csv",
        use_container_width=True,
    )

    # ì´ˆê¸°í™” ë²„íŠ¼
    st.markdown("### âš™ï¸ ê´€ë¦¬")
    if st.button("ì‘ë‹µ ì´ˆê¸°í™”(ëª¨ë‘ ì‚­ì œ)"):
        st.session_state.responses = []
        st.warning("ì‘ë‹µì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒë‹¨ í¼ì—ì„œ ë‹¤ì‹œ ì œì¶œí•´ ì£¼ì„¸ìš”.")
        st.rerun()

