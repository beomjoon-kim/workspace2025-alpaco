import os
import streamlit as st
from dotenv import load_dotenv
from openai import OpenAI

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1) í™˜ê²½ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
load_dotenv()
API_KEY = (os.getenv("OPENAI_API_KEY") or "").strip()
client = OpenAI(api_key=API_KEY)

st.set_page_config(page_title="ìš´ë™ í”Œë˜ë„ˆ ì±—ë´‡", page_icon="ğŸ‹ï¸")
st.title("ğŸ‹ï¸ ìš´ë™ í”Œë˜ë„ˆ ì±—ë´‡")
st.caption("ê°œì¸ ë§ì¶¤ í™ˆíŠ¸/ìš´ë™ ë£¨í‹´ì„ ì¶”ì²œí•©ë‹ˆë‹¤.")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2) ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (AI ì—­í•  ì •ì˜)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
system_prompt = {
    "role": "system",
    "content": "ë„ˆëŠ” ìš´ë™ í”Œëœì„ ì œê³µí•˜ëŠ” í”¼íŠ¸ë‹ˆìŠ¤ íŠ¸ë ˆì´ë„ˆì•¼. \
    ì‚¬ìš©ìì˜ ëª©í‘œ(ì²´ì¤‘ê°ëŸ‰, ê·¼ë ¥ê°•í™”, ë¶€ìœ„ë³„ ìš´ë™ ë“±)ì— ë§ì¶° \
    ìš´ë™ ë£¨í‹´ì„ ì„¸íŠ¸/íšŸìˆ˜/íœ´ì‹ê¹Œì§€ êµ¬ì²´ì ìœ¼ë¡œ ì œì‹œí•´ì¤˜."
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3) ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "messages" not in st.session_state:
    st.session_state["messages"] = [system_prompt]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4) ê¸°ì¡´ ëŒ€í™” í‘œì‹œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
for msg in st.session_state["messages"]:
    if msg["role"] != "system":
        with st.chat_message(msg["role"]):
            st.markdown(msg["content"])

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5) ì‚¬ìš©ì ì…ë ¥ â†’ ëª¨ë¸ í˜¸ì¶œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if user_input := st.chat_input("ì˜¤ëŠ˜ ìš´ë™ ë£¨í‹´ì„ ì•Œë ¤ì¤˜!"):
    # ì‚¬ìš©ì ë©”ì‹œì§€ ì €ì¥
    st.session_state["messages"].append({"role": "user", "content": user_input})
    with st.chat_message("user"):
        st.markdown(user_input)

    # ëª¨ë¸ í˜¸ì¶œ
    with st.chat_message("assistant"):
        with st.spinner("ìš´ë™ í”Œëœì„ êµ¬ì„±í•˜ëŠ” ì¤‘..."):
            response = client.chat.completions.create(
                model="gpt-4o-mini",
                messages=st.session_state["messages"]
            )
            answer = response.choices[0].message.content
            st.markdown(answer)

    # AI ì‘ë‹µ ì €ì¥
    st.session_state["messages"].append({"role": "assistant", "content": answer})
